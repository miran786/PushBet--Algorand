---
phase: 6
plan: 1
wave: 1
---

# Plan 6.1: Backend — Marketplace API & MongoDB Model

## Objective
Create the backend infrastructure for the AI-governed marketplace: MongoDB models for Needs/Claims, Express routes for CRUD operations, and Gemini AI proof verification endpoint.

## Context
- `.gsd/phases/6/RESEARCH.md`
- `server/server.js` — Main Express server (mounts routes)
- `server/routes/` — Existing route files
- `server/models/` — Existing Mongoose models
- `server/controllers/` — Existing controllers

## Tasks

<task type="auto">
  <name>Create Marketplace MongoDB Models</name>
  <files>server/models/Need.js, server/models/Claim.js</files>
  <action>
    Create two Mongoose models:
    
    **Need.js:**
    - `requesterWallet` (String, required) — Algorand address of the person posting the need
    - `description` (String, required) — Natural language description ("find my lost keys")
    - `reward` (Number, required) — ALGO reward amount
    - `status` (String, enum: ['open', 'claimed', 'verifying', 'completed', 'expired'], default: 'open')
    - `category` (String) — AI-generated category (e.g. "lost_item", "notes", "errand")
    - `aiTerms` (String) — Gemini-generated smart contract terms (what constitutes valid proof)
    - `claimedBy` (String) — Wallet address of the student who claimed it
    - `createdAt` (Date, default: Date.now)
    - `expiresAt` (Date) — Auto-expire after 48 hours
    
    **Claim.js:**
    - `needId` (ObjectId, ref: 'Need', required)
    - `claimerWallet` (String, required)
    - `proofDescription` (String) — Text description of how they fulfilled the need
    - `proofImage` (String) — Base64 or URL of proof image
    - `aiVerified` (Boolean, default: false)
    - `aiConfidence` (Number) — AI confidence score 0-1
    - `aiReason` (String) — AI explanation of verification result
    - `txId` (String) — Algorand transaction ID of the payout
    - `createdAt` (Date, default: Date.now)
  </action>
  <verify>node -e "const Need = require('./models/Need'); const Claim = require('./models/Claim'); console.log('Models loaded:', !!Need, !!Claim);"</verify>
  <done>Both models are importable without errors.</done>
</task>

<task type="auto">
  <name>Create Marketplace Routes & Controller</name>
  <files>server/controllers/marketplaceController.js, server/routes/marketplaceRoutes.js, server/server.js</files>
  <action>
    **marketplaceController.js** — Implement these endpoints:
    
    1. `POST /needs` — Create a new need
       - Input: `{ description, reward, requesterWallet }`
       - Call Gemini to analyze the description and generate:
         - `category` (classify the need)
         - `aiTerms` (what proof is needed to verify fulfillment)
       - Save to MongoDB, return the need with AI terms
    
    2. `GET /needs` — List all open needs
       - Filter: `status: 'open'`, sort by `createdAt` desc
       - Return array of needs
    
    3. `POST /needs/:id/claim` — Claim a need
       - Input: `{ claimerWallet }`
       - Validate need is 'open' and claimer != requester
       - Update status to 'claimed', set claimedBy
    
    4. `POST /needs/:id/submit-proof` — Submit proof for AI verification
       - Input: `{ claimerWallet, proofDescription, proofImage }`
       - Call Gemini to verify: send original need description + aiTerms + proof image/description
       - Gemini prompt: "Given this need: '{description}'. The required proof is: '{aiTerms}'. The claimer submitted: '{proofDescription}' with this image. Is this valid proof? Respond with JSON: {verified: true/false, confidence: 0-1, reason: 'explanation'}"
       - If verified (confidence > 0.7): update need status to 'completed', create Claim record
       - If not verified: return rejection reason, keep status as 'claimed'
    
    5. `GET /needs/:id` — Get single need with claims
    
    **marketplaceRoutes.js** — Wire all routes to controller
    
    **server.js** — Add: `app.use("/api/marketplace", require("./routes/marketplaceRoutes"));`
    
    Do NOT implement actual Algorand payment in this plan — that's Plan 6.2.
    Payment field (`txId`) stays null for now.
  </action>
  <verify>
    Start server and test with curl:
    curl -X POST http://localhost:8000/api/marketplace/needs -H "Content-Type: application/json" -d "{\"description\": \"Need 2024 calculus notes\", \"reward\": 5, \"requesterWallet\": \"TEST_ADDR\"}"
  </verify>
  <done>All 5 endpoints return correct responses. Gemini generates terms for new needs and verifies submitted proof.</done>
</task>

## Success Criteria
- [ ] Need model stores all fields correctly in MongoDB
- [ ] Claim model stores proof and AI verification results
- [ ] POST /needs creates a need with AI-generated terms
- [ ] POST /needs/:id/submit-proof runs Gemini verification
- [ ] Routes are mounted in server.js
